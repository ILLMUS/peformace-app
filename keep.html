<script>
/* ===== GLOBAL STATE (TOP OF FILE) ===== */
let currentUser = null;
let hasMerged = false;
const LS_KEY = 'pt_pro_trades_v1';
let trades = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
</script>
<script>
  /* ============================
   SUPABASE INIT
============================ */
const supabase = window.supabase.createClient(
  'https://iethtasvjadlbgfbeoae.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlldGh0YXN2amFkbGJnZmJlb2FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzYxNDYsImV4cCI6MjA4MTYxMjE0Nn0.6ttAmdttoGwfwAgjdK2SAwkpDqqqfUACzK-miEwherE'
);
(async () => {
  const { data, error } = await supabase.auth.getSession();
  console.log('SUPABASE SESSION:', data, error);
})();

</script>
<script>
/* ============================
   App state & helpers
   ============================ */

function save(){
   localStorage.setItem(LS_KEY, JSON.stringify(trades)); render(); }



const pairFactor = { US100:0.1, US500:1, XAUUSD:0.1, BTCUSD:0.05, EURUSD:0.1 }; // per 0.01 lot => $1/pt for indices (our convention)

/* ============================
   DOM refs
   ============================ */
const tbody = document.querySelector('#tradesTable tbody');
const tradeCountEl = document.getElementById('tradeCount');
const winRateEl = document.getElementById('winRate');
const avgWinEl = document.getElementById('avgWin');
const avgLossEl = document.getElementById('avgLoss');
const expectancyEl = document.getElementById('expectancy');
const pfEl = document.getElementById('pf');
const ddEl = document.getElementById('dd');
const netPLEl = document.getElementById('acctVal');
const livePriceEl = document.getElementById('livePrice');

/* ============================
   Utilities
   ============================ */

function perPointValue(pair, lots){
  // per point value assuming 0.01 lot => $1 for indices
  const factor = pairFactor[pair] || 1;
  return (lots * 100) * factor; // e.g. 0.05 -> 5 * factor
}

function calcResultFromPoints(pair, lots, points){
  return +(points * perPointValue(pair, lots)).toFixed(2);
}

/* ============================
   Adding / editing trades
   ============================ */
document.getElementById('addBtn').addEventListener('click', ()=>{
  const date = document.getElementById('date').value || (new Date()).toISOString().slice(0,10);
  const pair = document.getElementById('pair').value;
  const side = document.getElementById('side').value;
  const lots = parseFloat(document.getElementById('lots').value) || 0.01;
  let points = parseFloat(document.getElementById('points').value);
  const entry = parseFloat(document.getElementById('entry').value);
  const exit = parseFloat(document.getElementById('exit').value);
  let result = document.getElementById('result').value;
  const atr = document.getElementById('atr').value;
  const notes = document.getElementById('notes').value;

  if((!points || isNaN(points)) && entry && exit){
    points = +( (side === 'Buy') ? (exit - entry) : (entry - exit) ).toFixed(2);
  }
  if((!result || result==='') && points!=null && !isNaN(points)){
    result = calcResultFromPoints(pair, lots, points);
  } else result = result?Number(result):0;

  trades.push({ date, pair, side, lots, points, result, atr, notes, time: (new Date()).toISOString() });
  // clear fields
  document.getElementById('points').value=''; document.getElementById('result').value=''; document.getElementById('entry').value=''; document.getElementById('exit').value=''; document.getElementById('notes').value='';
  save();
});

/* Inline editing & delete */
function attachRowHandlers(){
  tbody.querySelectorAll('input').forEach(inp=>{
    inp.onchange = (e)=>{
      const i = +e.target.dataset.index;
      const f = e.target.dataset.field;
      trades[i][f] = isNaN(e.target.value) ? e.target.value : Number(e.target.value);
      // if fields affect result, recalc
      if(f==='lots' || f==='points' || f==='pair') {
        const t = trades[i];
        if(t.points!=null && !isNaN(t.points)) t.result = calcResultFromPoints(t.pair, t.lots, t.points);
      }
      save();
    };
  });
  tbody.querySelectorAll('.del').forEach(btn=> btn.onclick = ()=>{
    const i = +btn.dataset.index;
    trades.splice(i,1); save();
  });
}

/* ============================
   Rendering & analytics
   ============================ */
let equityChart;
function render(){
  // table
  tbody.innerHTML = '';
  trades.forEach((t,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${t.date}</td>
      <td>${t.pair}</td>
      <td>${t.side}</td>
      <td><input data-index="${i}" data-field="lots" value="${t.lots}" style="width:72px"></td>
      <td><input data-index="${i}" data-field="points" value="${t.points||''}" style="width:80px"></td>
      <td><input data-index="${i}" data-field="result" value="${t.result||''}" style="width:100px"></td>
      <td>${(t.notes||'')}</td>
      <td><button class="del" data-index="${i}">Del</button></td>
    `;
    tbody.appendChild(tr);
  });
  attachRowHandlers();

  // analytics
  const results = trades.map(t=>({ ...t, result: Number(t.result || 0) }));
  const total = results.reduce((s,r)=>s + r.result,0);
  const wins = results.filter(r=>r.result>0);
  const losses = results.filter(r=>r.result<=0);
  const avgWin = wins.length ? wins.reduce((s,r)=>s+r.result,0)/wins.length : 0;
  const avgLoss = losses.length ? losses.reduce((s,r)=>s+r.result,0)/losses.length : 0;
  const winRate = results.length ? (wins.length / results.length)*100 : 0;
  const grossWin = wins.reduce((s,r)=>s+r.result,0);
  const grossLoss = Math.abs(losses.reduce((s,r)=>s+r.result,0));
  const expectancy = (winRate/100)*avgWin - ((100-winRate)/100)*Math.abs(avgLoss);
  const pf = grossLoss ? (grossWin / grossLoss) : (grossWin>0?Infinity:0);

  document.getElementById('tradeCount').textContent = results.length;
  winRateEl.textContent = winRate.toFixed(1) + '%';
  avgWinEl.textContent = '$' + avgWin.toFixed(2);
  avgLossEl.textContent = '$' + Math.abs(avgLoss).toFixed(2);
  expectancyEl.textContent = '$' + expectancy.toFixed(2);
  pfEl.textContent = pf === Infinity ? '∞' : (pf?pf.toFixed(2):'0');
  document.getElementById('netPL')?.remove();
  document.getElementById('acctVal').textContent = '$' + total.toFixed(2);
  ddEl.textContent = '$' + maxDrawdown(results).toFixed(2);

  // equity chart
  const labels = results.map(r=>r.date);
  let cum = 0; const equity = results.map(r=> cum += r.result);
  if(!equityChart){
    const ctx = document.getElementById('equityChart').getContext('2d');
    equityChart = new Chart(ctx,{ type:'line', data:{ labels:labels, datasets:[{ label:'Equity', data:equity, fill:true, backgroundColor:'rgba(124,58,237,0.12)', borderColor:'#7c3aed'}]}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}} } });
  } else {
    equityChart.data.labels = labels;
    equityChart.data.datasets[0].data = equity;
    equityChart.update();
  }

  // heatmap & calendar
  renderHeatmap(results);
  renderCalendar(results);
}

/* max drawdown */
function maxDrawdown(results){
  let cum=0, peak=-Infinity, maxDD=0;
  results.forEach(r => { cum += r.result; if(cum>peak) peak=cum; const dd = peak - cum; if(dd>maxDD) maxDD = dd; });
  return maxDD;
}

/* ============================
   Heatmap & Calendar
   ============================ */
function renderHeatmap(results){
  const heatWrap = document.getElementById('heatmap'); heatWrap.innerHTML = '';
  // grid: Mon..Sun x 24 hours (we show 7 cols; each cell will be Day label + Hour block approximated)
  // We'll aggregate by day-of-week (0=Sun..6=Sat) and hour (0..23). For mobile compactness we show day-of-week with weighted color by avg result
  const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  // compute per-day stats
  const dayStats = {}; for(let i=0;i<7;i++) dayStats[i]={count:0, sum:0};
  results.forEach(r=>{
    const d = new Date(r.time || r.date);
    const day = d.getDay();
    dayStats[day].count++; dayStats[day].sum += r.result;
  });
  // render 7 cells
  for(let i=1;i<=7;i++){
    const idx = i%7; // show Mon..Sun more readable maybe
    const st = dayStats[idx];
    const val = st.count ? st.sum / st.count : 0;
    const intensity = Math.min(1, Math.abs(val) / 100); // normalize
    let bg = 'rgba(255,255,255,0.03)';
    if(val>0) bg = `rgba(16,185,129,${0.15 + intensity*0.7})`; // green
    if(val<0) bg = `rgba(239,68,68,${0.15 + intensity*0.7})`; // red
    const el = document.createElement('div'); el.className='heat-cell'; el.style.background=bg;
    el.title = `${dow[idx]} • trades ${st.count} • avg $${st.count? (st.sum/st.count).toFixed(2):0}`;
    el.textContent = `${dow[idx]} ${st.count? '('+st.count+')':''}`;
    heatWrap.appendChild(el);
  }
}

function renderCalendar(results){
  const cal = document.getElementById('calendar'); cal.innerHTML='';
  // group by date (YYYY-MM-DD)
  const map = {};
  results.forEach(r=>{ const d = (r.date || r.time).slice(0,10); map[d] = map[d]||{count:0,sum:0}; map[d].count++; map[d].sum += r.result; });
  // show last 30 days
  const days=30; const now = new Date();
  for(let i=days-1;i>=0;i--){
    const d = new Date(now); d.setDate(now.getDate()-i);
    const key = d.toISOString().slice(0,10);
    const obj = map[key] || {count:0,sum:0};
    const el = document.createElement('div'); el.className='heat-cell';
    // color by sum
    const intensity = Math.min(1, Math.abs(obj.sum)/100);
    if(obj.count===0) el.style.background = 'rgba(255,255,255,0.02)';
    else if(obj.sum>0) el.style.background = `rgba(16,185,129,${0.15 + intensity*0.7})`;
    else el.style.background = `rgba(239,68,68,${0.15 + intensity*0.7})`;
    el.title = `${key} • trades ${obj.count} • net $${obj.sum.toFixed(2)}`;
    el.textContent = `${d.getDate()}`;
    cal.appendChild(el);
  }
}

/* ============================
   CSV import/export
   ============================ */
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader(); reader.onload = ev=>{
    const rows = ev.target.result.split(/\r?\n/).filter(r=>r.trim());
    rows.forEach(r=>{
      const cols = r.split(',').map(c=>c.trim());
      // expected: date,pair,side,lots,points,result,notes
      const obj = {
        date: cols[0] || (new Date()).toISOString().slice(0,10),
        pair: cols[1] || 'US100',
        side: cols[2] || 'Buy',
        lots: Number(cols[3]||0.01),
        points: Number(cols[4]||0),
        result: cols[5]?Number(cols[5]):calcResultFromPoints(cols[1]||'US100', Number(cols[3]||0.01), Number(cols[4]||0)),
        notes: cols[6] || ''
      };
      trades.push(obj);
    });
    save();
  };
  reader.readAsText(f);
});

document.getElementById('downloadCsv').addEventListener('click', ()=>{
  const csv = trades.map(t=> `${t.date},${t.pair},${t.side},${t.lots},${t.points||''},${t.result||''},${(t.notes||'')}`).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='trades_export.csv'; a.click(); URL.revokeObjectURL(url);
});

/* ============================
   Live Price Integration
   ============================ */
let autoPrice = false, autoInterval;

document.getElementById('provider').addEventListener('change', e=>{
  document.getElementById('customUrl').style.display = e.target.value==='custom' ? 'block' : 'none';
});

document.getElementById('getPriceBtn').addEventListener('click', fetchPrice);
document.getElementById('autoPriceBtn').addEventListener('click', ()=>{
  autoPrice = !autoPrice;
  document.getElementById('autoPriceBtn').textContent = autoPrice ? 'Auto: On' : 'Auto: Off';
  if(autoPrice){ autoInterval = setInterval(fetchPrice, 15000); fetchPrice(); } else clearInterval(autoInterval);
});

async function fetchPrice(){
  const provider = document.getElementById('provider').value;
  const symbol = encodeURIComponent(document.getElementById('symbol').value.trim());
  const apikey = document.getElementById('apiKey').value.trim();
  const custom = document.getElementById('customUrl').value.trim();

  if(!symbol || (!apikey && provider!=='custom' && !custom)){ alert('Please enter symbol and API key (or provide custom URL).'); return; }

  try {
    livePriceEl.textContent = 'Connecting…';
    let url;
    if(provider==='twelvedata'){
      // TwelveData price endpoint
      url = `https://api.twelvedata.com/price?symbol=${symbol}&apikey=${apikey}`;
      const res = await fetch(url);
      const j = await res.json();
      if(j.price!==undefined) { livePriceEl.textContent = `${symbol} → ${j.price}`; return; }
      throw new Error(j.message || 'invalid response');
    } else if(provider==='finnhub'){
      url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${apikey}`;
      const res = await fetch(url);
      const j = await res.json();
      if(j.c!==undefined){ livePriceEl.textContent = `${symbol} → ${j.c}`; return; }
      throw new Error('invalid response');
    } else {
      // custom template: expects {symbol} and {apikey}
      url = custom.replace(/{symbol}/g, symbol).replace(/{apikey}/g, apikey);
      const res = await fetch(url);
      const j = await res.json();
      // try common fields
      const possible = j.price || j.c || j.data?.price || j[0]?.price || j[0]?.p;
      if(possible!==undefined) { livePriceEl.textContent = `${symbol} → ${possible}`; return; }
      livePriceEl.textContent = JSON.stringify(j).slice(0,200);
    }
  } catch (err){
    livePriceEl.textContent = 'Error: ' + (err.message || err);
  }
}

/* ============================
   Monthly PDF report (jsPDF + html2canvas)
   ============================ */
document.getElementById('monthlyPdfBtn').addEventListener('click', async ()=>{
  await generateMonthlyPDF();
});

async function generateMonthlyPDF(){
  // Build a simple report element in DOM, capture with html2canvas
  const month = new Date().toISOString().slice(0,7);
  const filtered = trades.filter(t => (t.date||'').slice(0,7) === month);
  // summary
  const wins = filtered.filter(t=>t.result>0), losses = filtered.filter(t=>t.result<=0);
  const grossWin = wins.reduce((s,r)=>s+r.result,0), grossLoss = Math.abs(losses.reduce((s,r)=>s+r.result,0));
  const winRate = filtered.length ? (wins.length/filtered.length)*100 : 0;
  const avgWin = wins.length ? (grossWin/wins.length) : 0;
  const avgLoss = losses.length ? (grossLoss/losses.length) : 0;
  const pf = grossLoss ? (grossWin/grossLoss) : (grossWin>0?Infinity:0);

  // create a report node
  const node = document.createElement('div'); node.style.padding='18px'; node.style.background='#fff'; node.style.color='#000'; node.style.width='800px';
  node.innerHTML = `<h2>Monthly Report — ${month}</h2>
    <p>Total trades: ${filtered.length} • Wins: ${wins.length} • Losses: ${losses.length} • Win rate: ${winRate.toFixed(1)}%</p>
    <p>Gross win: $${grossWin.toFixed(2)} • Gross loss: $${grossLoss.toFixed(2)} • Profit factor: ${pf===Infinity?'∞':pf.toFixed(2)}</p>
    <p>Avg win: $${avgWin.toFixed(2)} • Avg loss: $${avgLoss.toFixed(2)}</p>
    <h3>Equity Snapshot</h3>
    <div id="rep-chart" style="width:760px;height:220px"></div>
    <h3>Top trades</h3>
    <ol>${filtered.sort((a,b)=>b.result-a.result).slice(0,10).map(t=>`<li>${t.date} ${t.pair} ${t.side} $${t.result.toFixed(2)} (${t.notes||''})</li>`).join('')}</ol>
  `;

  document.body.appendChild(node);

  // render equity inside #rep-chart using Chart.js canvas
  const canvas = document.createElement('canvas'); canvas.width=760; canvas.height=220; node.querySelector('#rep-chart').appendChild(canvas);
  const ctx = canvas.getContext('2d'); let cum=0; const labels = []; const data=[];
  filtered.forEach(t=>{ labels.push(t.date); cum += t.result; data.push(cum); });
  new Chart(ctx,{ type:'line', data:{ labels, datasets:[{ label:'Equity', data, borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,0.12)', fill:true }] }, options:{responsive:false,plugins:{legend:{display:false}}}});

  // capture node
  const canvasImg = await html2canvas(node, { scale:2 });
  const imgData = canvasImg.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:'portrait', unit:'px', format:'a4' });
  const pdfW = pdf.internal.pageSize.getWidth();
  const pdfH = pdf.internal.pageSize.getHeight();
  // scale to width
  const imgW = pdfW - 40; const imgH = (canvasImg.height * imgW) / canvasImg.width;
  pdf.addImage(imgData, 'PNG', 20, 20, imgW, imgH);
  pdf.save(`monthly_report_${month}.pdf`);
  document.body.removeChild(node);
}

/* ============================
   Download HTML (save to file)
   ============================ */
document.getElementById('downloadAll').addEventListener('click', ()=>{
  const html = '<!doctype html>\\n' + document.documentElement.outerHTML;
  const blob = new Blob([html], {type:'text/html'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download='performance_tracker_pro.html'; a.click(); URL.revokeObjectURL(url);
});

/* ============================
   Other UI handlers
   ============================ */
document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('Clear all trades?')){ trades=[]; save(); }});
document.getElementById('downloadAll').addEventListener('click', ()=>{}); // handled above
document.getElementById('themeSel').addEventListener('change', e=> document.body.setAttribute('data-theme', e.target.value));
document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('Clear all trades?')){ trades=[]; save(); }});

// export monthly PDF (quick)
document.getElementById('monthlyPdfBtn').addEventListener('click', ()=> generateMonthlyPDF());

// init
render();


/*==============
=============
   //MODAL
   ============
===========*/
const loginModal = document.getElementById('loginModal');
const modalEmail = document.getElementById('modalEmail');
const modalPassword = document.getElementById('modalPassword');
const modalLoginBtn = document.getElementById('modalLoginBtn');
const modalSignupBtn = document.getElementById('modalSignupBtn');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalMsg = document.getElementById('modalMsg');

const authButtons = document.getElementById('authButtons');
const loginHeaderBtn = document.getElementById('loginHeaderBtn');
const signupHeaderBtn = document.getElementById('signupHeaderBtn');


// Show/Hide modal
function showModal(){ 
  loginModal.style.display='flex'; 
  modalMsg.textContent=''; 
  modalEmail.value = '';
  modalPassword.value = '';
}

function hideModal(){ 
  loginModal.style.display='none'; 
}


// Open modal from header buttons
loginHeaderBtn.onclick = showModal;
signupHeaderBtn.onclick = showModal;
modalCloseBtn.onclick = hideModal;

// ---------------- LOGIN ----------------
modalLoginBtn.onclick = async () => {
  const email = modalEmail.value.trim();
  const password = modalPassword.value.trim();

  if(!email || !password){
    modalMsg.textContent = 'Email and password are required!';
    return;
  }

  modalMsg.textContent = 'Logging in…';

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){
    modalMsg.textContent = error.message;
    return;
  }

  currentUser = data.user;
  updateAuthUI();
  hideModal();
  await loadTrades(); // load user trades
};

// ---------------- SIGNUP ----------------
modalSignupBtn.onclick = async () => {
  const email = modalEmail.value.trim();
  const password = modalPassword.value.trim();

  if(!email || !password){
    modalMsg.textContent = 'Email and password are required!';
    return;
  }

  modalMsg.textContent = 'Signing up…';

  const { data, error } = await supabase.auth.signUp({ email, password });

  if(error){
    modalMsg.textContent = error.message;
    return;
  }

  modalMsg.style.color = 'green';
  modalMsg.textContent = 'Check your email to confirm your account.';
};

// ---------------- LOGOUT ----------------
async function logout(){
  await supabase.auth.signOut();
  currentUser = null;
  updateAuthUI();
}

/*// ---------------- ADD TRADE CHECK ----------------
document.getElementById('addBtn').addEventListener('click', () => {
  if(!currentUser){
    showModal();
    return;
  }
  // Your existing add trade logic
});
*/
// Initialize UI
updateAuthUI();


</script>
<script>





let modalAuthType = 'login'; // track modal type

/* ============================
   MODAL ELEMENTS
============================ */


const loginHeaderBtn = document.getElementById('loginHeaderBtn');
const signupHeaderBtn = document.getElementById('signupHeaderBtn');

/* ============================
   SHOW/HIDE MODAL
============================ */
function showModal(type = 'login') {
  modalAuthType = type;
  loginModal.style.display = 'flex';
  modalMsg.textContent = '';
  modalMsg.style.color = 'rgb(199, 224, 199)';
  modalEmail.value = '';
  modalPassword.value = '';
}

function hideModal() {
  loginModal.style.display = 'none';
}

/* ============================
   UPDATE HEADER UI
============================ */
function updateAuthUI() {
  const userBar = document.getElementById('userBar');
  const userEmail = document.getElementById('userEmail');

  if (currentUser) {
    authButtons.style.display = 'none';
    if(userBar) userBar.style.display = 'flex';
    if(userEmail) userEmail.textContent = currentUser.email;
  } else {
    authButtons.style.display = 'flex';
    if(userBar) userBar.style.display = 'none';
    if(userEmail) userEmail.textContent = '';
  }
}

/* ============================
   LOGIN / SIGNUP HANDLER
============================ */
async function handleAuth(type) {
  const email = modalEmail.value.trim();
  const password = modalPassword.value.trim();

  if(!email || !password){
    modalMsg.textContent = 'Email and password are required!';
    modalMsg.style.color = 'red';
    return;
  }

  modalMsg.textContent = type === 'login' ? 'Logging in…' : 'Signing up…';
  modalMsg.style.color = 'rgb(199, 224, 199)';

  if(type === 'login') {
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){
      modalMsg.textContent = error.message.includes('Invalid login') 
        ? 'You are not registered. Please sign up.' 
        : error.message;
      modalMsg.style.color = 'red';
      return;
    }
    currentUser = data.user;
    hideModal();
    updateAuthUI();
    await mergeLocalToCloud();
    await loadTrades();
  } else { // signup
    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error){
      modalMsg.textContent = error.message;
      modalMsg.style.color = 'red';
      return;
    }
    modalMsg.textContent = 'Check your email to confirm your account.';
    modalMsg.style.color = 'green';
  }
}

/* ============================
   BUTTON EVENTS
============================ */
modalLoginBtn.onclick = () => handleAuth('login');
modalSignupBtn.onclick = () => handleAuth('signup');
modalCloseBtn.onclick = hideModal;

// Header buttons
loginHeaderBtn.onclick = () => showModal('login');
signupHeaderBtn.onclick = () => showModal('signup');

// Logout
async function logout(){
  await supabase.auth.signOut();
  currentUser = null;
  updateAuthUI();
}

/* ============================
   ADD TRADE & SYNC
============================ */
document.getElementById('addBtn').addEventListener('click', async ()=>{
  if(!currentUser){
    showModal('login');
    return;
  }

  // your existing add trade logic here...
  const date = document.getElementById('date').value || (new Date()).toISOString().slice(0,10);
  const pair = document.getElementById('pair').value;
  const side = document.getElementById('side').value;
  const lots = parseFloat(document.getElementById('lots').value) || 0.01;
  let points = parseFloat(document.getElementById('points').value);
  const entry = parseFloat(document.getElementById('entry').value);
  const exit = parseFloat(document.getElementById('exit').value);
  let result = document.getElementById('result').value;
  const atr = document.getElementById('atr').value;
  const notes = document.getElementById('notes').value;

  if((!points || isNaN(points)) && entry && exit){
    points = +( (side === 'Buy') ? (exit - entry) : (entry - exit) ).toFixed(2);
  }
  if((!result || result==='') && points!=null && !isNaN(points)){
    result = +(points * lots * 100).toFixed(2); // simple calc
  } else result = result?Number(result):0;

  const trade = { date, pair, side, lots, points, result, atr, notes, time: (new Date()).toISOString() };
  trades.push(trade);
  localStorage.setItem(LS_KEY, JSON.stringify(trades));
  render();

  // Sync to Supabase
  try {
    await supabase.from('trades').insert({ ...trade, user_id: currentUser.id });
  } catch(err){
    console.error('Supabase insert error', err);
  }
});

/* ============================
   SESSION RESTORE
============================ */
async function restoreSession() {
  const { data } = await supabase.auth.getSession();
  currentUser = data.session?.user || null;
  updateAuthUI();
  if(currentUser) await mergeLocalToCloud();
}

/* ============================
   MERGE LOCAL TRADES TO CLOUD
============================ */
async function mergeLocalToCloud(){
  if(hasMerged || !currentUser) return;
  hasMerged = true;

  const localTrades = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  if(!localTrades.length) return;

  const uploads = localTrades.map(t => ({ ...t, user_id: currentUser.id }));
  await supabase.from('trades').upsert(uploads);
}

/* ============================
   LOAD TRADES
============================ */
async function loadTrades() {
  if(!currentUser) return;
  const { data, error } = await supabase.from('trades').select('*').eq('user_id', currentUser.id);
  if(error){ console.error(error); return; }
  trades = data;
  render();
}

/* ============================
   AUTH STATE CHANGE
============================ */
supabase.auth.onAuthStateChange(async (_event, session)=>{
  currentUser = session?.user || null;
  updateAuthUI();
  if(currentUser) await mergeLocalToCloud();
});
supabase.auth.onAuthStateChange((event, session) => {
  console.log('AUTH EVENT:', event, session);
});




async function testInsert(){
  const { data, error } = await supabase.from('trades').insert({
    pair: 'US100',
    side: 'BUY',
    lots: 0.01,
    points: 10,
    result: 5,
    user_id: currentUser?.id
  });

  console.log('INSERT TEST:', data, error);
}
testInsert();

/* ============================
   APP INIT
============================ */
(async function initApp(){
  await restoreSession();
  render();
})();
</script>
